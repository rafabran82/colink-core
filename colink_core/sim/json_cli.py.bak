from __future__ import annotations

import argparse
import json
import os
import sys
from pathlib import Path

from .run_sweep import simulate_gbm_paths, plot_paths, plot_hist
import matplotlib


def _debug_enabled(args) -> bool:
    return bool(getattr(args, "debug", False) or "--debug" in sys.argv or os.getenv("COLINK_DEBUG") == "1")


def cmd_quote(args) -> None:
    # tiny deterministic quote stub identical to your earlier behavior
    col_in = float(getattr(args, "col_in", 8000.0))
    min_out_bps = float(getattr(args, "min_out_bps", 150.0))
    twap_guard = bool(getattr(args, "twap_guard", True))
    haircut = 0.015 if min_out_bps >= 150 else 0.005
    min_out = col_in * (1.0 - haircut)
    data = {
        "col_in": col_in,
        "min_out_bps": min_out_bps,
        "min_out": round(min_out, 3),
        "copx_out": round(min_out, 3),
        "eff_copx_per_col": round(min_out / col_in, 3),
        "twap_guard": twap_guard,
        "raw": {"note": "smoke-quote", "inputs": {"col_in": col_in, "min_out_bps": min_out_bps, "twap_guard": twap_guard}, "calc": {"haircut": haircut}},
    }
    print(json.dumps(data))


def cmd_sweep(args) -> None:
    outdir = Path(getattr(args, "outdir", "charts"))
    outdir.mkdir(parents=True, exist_ok=True)

    # force headless backend at runtime too
    try:
        matplotlib.use("Agg")
    except Exception:
        pass

    charts: list[str] = []
    try:
        paths = simulate_gbm_paths(
            n_paths=int(getattr(args, "n_paths", 200)),
            steps=int(getattr(args, "steps", 120)),
            dt=float(getattr(args, "dt", 1.0)),
            mu=float(getattr(args, "mu", 0.0)),
            sigma=float(getattr(args, "sigma", 0.2)),
            seed=(int(args.seed) if getattr(args, "seed", None) is not None else None),
        )
        p1 = outdir / "sweep_paths-0000.png"
        p2 = outdir / "sweep_hist-0000.png"
        plot_paths(paths, p1)
        plot_hist(paths, p2)
        charts.extend([str(p1), str(p2)])
    except Exception as e:
        if _debug_enabled(args):
            raise
        # Emit a small hint for diagnosis and still provide placeholders
        try:
            sys.stdout.write(json.dumps({"error": {"type": e.__class__.__name__, "msg": str(e), "backend": getattr(matplotlib, "get_backend", lambda: "?")()}}) + "\n")
        except Exception:
            pass
        for name in ("sweep_paths-PLACEHOLDER.png", "sweep_hist-PLACEHOLDER.png"):
            try:
                p = outdir / name
                p.write_bytes(b"")
                charts.append(str(p))
            except Exception:
                pass

    print(json.dumps({"charts": charts}))


def main(argv: list[str] | None = None) -> int:
    parser = argparse.ArgumentParser("colink-json")
    parser.add_argument("--version", action="store_true", help="print version")
    parser.add_argument("--debug", action="store_true", help="raise on errors (traceback)")
    sub = parser.add_subparsers(dest="cmd", required=False)

    p_q = sub.add_parser("quote")
    p_q.add_argument("--col-in", type=float, dest="col_in", default=8000.0)
    p_q.add_argument("--min-out-bps", type=float, dest="min_out_bps", default=150.0)
    p_q.add_argument("--twap-guard", action="store_true", dest="twap_guard", default=True)

    p_s = sub.add_parser("sweep")
    p_s.add_argument("--outdir", type=str, default="charts")
    p_s.add_argument("--n-paths", type=int, dest="n_paths", default=200)
    p_s.add_argument("--steps", type=int, default=120)
    p_s.add_argument("--dt", type=float, default=1.0)
    p_s.add_argument("--mu", type=float, default=0.0)
    p_s.add_argument("--sigma", type=float, default=0.2)
    p_s.add_argument("--seed", type=int, default=None)
    p_s.add_argument("--debug", action="store_true")

    args = parser.parse_args(argv)

    if args.version:
        # Avoid importlib.metadata to keep it simple
        print("0.3.5")
        return 0

    if args.cmd == "quote":
        cmd_quote(args)
        return 0
    if args.cmd == "sweep":
        cmd_sweep(args)
        return 0

    # default when no subcmd -> show help
    parser.print_help()
    return 2


if __name__ == "__main__":
    raise SystemExit(main())
