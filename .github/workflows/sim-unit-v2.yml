name: sim-unit-v2

on:
  pull_request:
    branches: [ main ]
    types: [ opened, synchronize, reopened ]
  workflow_dispatch:

jobs:
  test:
    runs-on: windows-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          if (Test-Path pyproject.toml) {
            pip install -e ".[dev]"
          } elseif (Test-Path requirements.txt) {
            pip install -r requirements.txt
          }
          pip install numpy matplotlib

      - name: NumPy / Matplotlib smoke
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path .artifacts | Out-Null
          $py = @'
          import os, numpy as np, matplotlib
          import matplotlib.pyplot as plt
          x = np.linspace(0, 6.28318, 200)
          y = np.sin(x)
          plt.plot(x, y)
          plt.title("smoke")
          plt.savefig(".artifacts/smoke.png", dpi=120)
          print("matplotlib backend:", matplotlib.get_backend())
          '@
          $tmp = Join-Path $env:TEMP ("smoke_{0}.py" -f ([guid]::NewGuid()))
          Set-Content -Path $tmp -Value $py -Encoding utf8
          python $tmp

      - name: Run tests
        shell: pwsh
        run: |
          if (Test-Path pytest.ini -or (Get-ChildItem -Recurse -Filter "test_*.py" -ErrorAction SilentlyContinue)) {
            pytest -q
          } else {
            Write-Host "No tests found; skipping."
          }
