name: Sim Unit (Headless)

on:
  pull_request:
    branches: [ main ]
    paths:
      - "colink_core/**"
      - "tests/**"
      - ".github/workflows/sim-unit.yml"
  workflow_dispatch:

jobs:
  unit:
  env:
    MPLBACKEND: Agg
    name: unit (${{ matrix.os }}, ${{ matrix.python-version }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
        python-version: ["3.11"]

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install deps
  shell: bash
  run: |
    set -euxo pipefail
    python -m pip install -U pip setuptools wheel
    # Baseline CI deps so tests can run no matter what
    pip install -r tools/ci-reqs.txt
    # Try project install with extras; fall back gracefully
    if ! pip install -e .[test] ; then
      pip install -e .
    fi
    # Quick sanity prints
    python - <<'PY'
import sys, pkgutil
print("Python:", sys.version)
for m in ("numpy","pandas","matplotlib","pyarrow","tabulate","pytest"):
    try:
        mod = __import__(m)
        ver = getattr(mod, "__version__", "unknown")
    except Exception as e:
        ver = f"MISSING ({e})"
    print(f"{m}: {ver}")
PY
  shell: bash
  run: |
    set -euxo pipefail
    python -m pip install -U pip setuptools wheel
    # Try editable install with [test]; if extras are not defined, fall back to plain install
    if ! pip install -e .[test] ; then
      pip install -e .
    fi
    # Core test/runtime utilities
    pip install -U pytest pytest-cov
    # Headless plotting + summaries
    pip install -U matplotlib tabulate
    # Parquet engine for collect.py
    pip install -U pyarrow
    # Sanity prints
    python - <<'PY'
import sys, pkgutil
print("Python:", sys.version)
for m in ("numpy","pandas","matplotlib","pyarrow","tabulate","pytest"):
    mod = pkgutil.find_loader(m)
    print(f"{m}:", __import__(m).__version__ if mod else "MISSING")
PY
  shell: bash
  run: |
    python -m pip install -U pip setuptools wheel
    pip install -e .[test]
    pip install matplotlib tabulate pyarrow
    python - <<'PY'
import matplotlib, sys
print("Matplotlib:", matplotlib.__version__)
PY
- name: Run headless tests
        shell: bash
        run: pytest -q -k "headless" tests

      - name: Upload headless artifacts (best effort)
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: headless-artifacts-${{ matrix.os }}
          path: |
            .sim_smoke/*.png
          if-no-files-found: ignore



