name: sim-smoke

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  smoke:
    name: smoke (${{ matrix.os }}, ${{ matrix.label }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            pairs: "XRP/COL"
            label: "XRP-COL"
          - os: ubuntu-latest
            pairs: "COPX/COL"
            label: "COPX-COL"
          - os: windows-latest
            pairs: "XRP/COL"
            label: "XRP-COL"
          - os: windows-latest
            pairs: "COPX/COL"
            label: "COPX-COL"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install minimal deps for sim display
        run: |
          python -m pip install --upgrade pip
          python -m pip install numpy matplotlib
        shell: bash

      - name: Run smoke (headless Agg)
        shell: pwsh
        run: ./tools/verify-sim.ps1 -RunSim -Seed 123 -Pairs "${{ matrix.pairs }}" -Which headless-agg

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sim-smoke-${{ matrix.os }}-${{ matrix.label }}
          path: |
            .sim_smoke/sim_smoke_agg.png
            .sim_smoke/sim_from_engine.json
          if-no-files-found: warn


