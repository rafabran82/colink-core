name: Merge Dependabot Open PRs

on:
  workflow_dispatch:
  schedule:
    - cron: "0 9 * * 1"  # Mondays 09:00 UTC

permissions:
  contents: write
  pull-requests: write

jobs:
  merge-dependabot:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Merge any open Dependabot PRs
        env:
          GH_TOKEN: ${{ secrets.MDO_PAT }}
          REPO: ${{ github.repository }}
        run: |
          echo "Repo: $REPO"
          # List open PRs and filter to Dependabot
          gh pr list --repo "$REPO" --state open --json number,author,headRefName \
          | jq -r '.[] | select(.author.login=="dependabot[bot]") | .number' \
          | while read pr; do
              echo "Processing PR #$pr"
              # Approve (harmless if not needed)
              gh pr review "$pr" --approve --repo "$REPO" || true
              # Queue auto-merge (squash)
              gh pr merge "$pr" --squash --auto --repo "$REPO" || true
            done