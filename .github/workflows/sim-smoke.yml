name: Sim Display Smoke

on:
  push:
    branches: [ main ]
    paths:
      - "colink_core/**"
      - "tools/verify-sim.ps1"
      - ".github/workflows/sim-smoke.yml"
  workflow_dispatch:

jobs:
  smoke:
    name: smoke (${{ matrix.os }}, ${{ matrix.pair }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
        pair: ["XRP/COL", "COPX/COL"]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        shell: bash
        run: |
          python -m pip install -U pip
          pip install -e ".[sim]" matplotlib pytest ruff

      - name: Run verify-sim (seeded, multi-pair)
        shell: pwsh
        run: ./tools/verify-sim.ps1 -RunSim -Seed 123 -Pairs "XRP/COL,COPX/COL"
  - name: Dump .sim_smoke contents
    shell: pwsh
    run: |
      Write-Host 'GITHUB_WORKSPACE:' 
      Get-ChildItem -Recurse -Force . | Select-Object FullName, Length | Format-Table -AutoSize
      if (Test-Path '.sim_smoke') { Get-ChildItem -Recurse -Force .sim_smoke | Select-Object FullName, Length | Format-Table -AutoSize } else { Write-Host 'No .sim_smoke dir yet.' }
`n
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sim-smoke-${{ matrix.os }}-${{ matrix.pair }}
          path: |
            .sim_smoke/sim_smoke_agg.png
            .sim_smoke/sim_from_engine*.png
          if-no-files-found: error


