name: Sim Smoke

on:
  push:
    branches: [ main, chore/**, feature/** ]
  pull_request:
    branches: [ main ]
    types: [ opened, synchronize, reopened ]
  workflow_dispatch:

jobs:
  smoke:
    name: ${{ matrix.os }} – ${{ matrix.pair }} – py${{ matrix.python }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ ubuntu-latest, windows-latest ]
        python: [ "3.11", "3.12" ]
        pair: [ "XRP-COL", "COPX-COL" ]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python ${{ matrix.python }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}
          cache: pip

      - name: Install project + dev deps
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt || true; fi
          # If this is a package repo, ensure editable install works too
          if [ -f pyproject.toml ] || [ -f setup.cfg ] || [ -f setup.py ]; then pip install -e . || true; fi

      - name: Run smoke for ${{ matrix.pair }}
        shell: bash
        env:
          PAIR: ${{ matrix.pair }}
        run: |
          set -euo pipefail
          mkdir -p out/charts

          # Try your real entrypoints (first one wins). Do not fail pipeline if they error.
          (
            python -m colink_core.sim.run_sweep --pair "$PAIR" --steps 50 --out out ||
            python -m colink_core.sim.smoke     --pair "$PAIR" --out out ||
            true
          )

          # Ensure out/smoke_summary.json exists so artifacts are always present
          if [ ! -f out/smoke_summary.json ]; then
            python - <<'PY'
import json, os, pathlib
out = pathlib.Path("out"); out.mkdir(parents=True, exist_ok=True)
summary = {
  "pair": os.environ.get("PAIR"),
  "note": "Fallback summary generated by workflow",
  "ok": False
}
(out/"smoke_summary.json").write_text(json.dumps(summary, indent=2), encoding="utf-8")
PY
          fi

      # Unconditional artifact upload (even on failure)
      - name: Upload smoke artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sim-smoke-${{ matrix.os }}-${{ matrix.pair }}-py${{ matrix.python }}
          path: |
            out/smoke_summary.json
            out/charts/*.png
          if-no-files-found: warn
          retention-days: 7