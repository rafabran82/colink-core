name: Auto Merge

on:
  schedule:
    - cron: "0 5,17 * * *"   # Twice daily: 05:00 & 17:00 UTC
  workflow_dispatch:

jobs:
  merge:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Auto approve, merge, and cleanup
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üîÅ Checking open PRs..."
          prs=$(gh pr list --state open --json number,headRefName -q '.[] | [.number, .headRefName]')
          if [ -z "$prs" ]; then
            echo "‚úÖ No open PRs to process."
            exit 0
          fi
          echo "$prs" | jq -r '.[]' | while read -r pr branch; do
            echo "‚û°Ô∏è  Processing PR #$pr on branch $branch"
            gh pr checks "$pr" --watch || true
            if gh pr merge "$pr" --squash --admin; then
              echo "üßπ Deleting merged branch $branch"
              gh api -X DELETE "repos/${{ github.repository }}/git/refs/heads/$branch" || true
            else
              echo "‚ö†Ô∏è Could not merge PR #$pr"
            fi
          done
