name: sim-unit-v2b

on:
  workflow_dispatch:
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened]

jobs:
  sim:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: pwsh
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install -U pip
          pip install -e .
          # ensure pytest is available even if it's not in extras
          pip install pytest

      - name: Run unit tests
        run: |
          python -m pytest -q

      - name: Write summary artifact
        if: always()
        run: |
          New-Item -ItemType Directory -Path .artifacts -Force | Out-Null

          $summary = @"
          sim-unit-v2b summary
          Branch: $env:GITHUB_REF_NAME
          Commit: $env:GITHUB_SHA
          Runner: $env:RUNNER_OS
          Run ID: $env:GITHUB_RUN_ID
          "@

          $summary | Set-Content -Path .artifacts/summary.txt -Encoding utf8

      - name: Upload summary
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sim-unit-v2b-summary
          path: .artifacts/summary.txt
