name: PR CI

on:
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened]
  workflow_dispatch:

jobs:
  build-test:
    runs-on: ubuntu-latest
    env:
      BACKEND: Agg

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install deps (pandas/pyarrow/jsonschema/tabulate/matplotlib)
        run: |
          python -m pip install --upgrade pip
          pip install pandas pyarrow jsonschema tabulate matplotlib

      - name: Run sim demo (Phase 3)
        run: |
          python -m colink_core.sim.run --demo --display "${BACKEND}" --out-prefix ./.artifacts/demo

      - name: Run bridge demo (Phase 4)
        run: |
          python -m colink_core.bridge.run \
            --amount 1500 \
            --pairA COL/COPX \
            --pairM COPX/XRP \
            --out-prefix ./.artifacts/bridge_demo \
            --backend "${BACKEND}" \
            --sha "${{ github.sha }}"

      - name: Wrap sim metrics (produce *.metrics.json)
        run: |
          python tools/metrics_wrap.py --artifacts ./.artifacts

      - name: Enrich metrics (os/sha/backend)
        run: |
          python tools/enrich_metrics.py --artifacts ./.artifacts --os "${{ runner.os }}" --sha "${{ github.sha }}" --backend "${BACKEND}"

      - name: Validate metrics JSON (dispatch by schema_version)
        run: |
          python tools/validate_metrics.py

      - name: Merge NDJSON + JSON into CSV/Parquet
        run: |
          python tools/collect.py \
            --artifacts ./.artifacts \
            --out-dataset ./.artifacts/dataset.csv \
            --out-parquet ./.artifacts/dataset.parquet \
            --os "${{ runner.os }}" \
            --sha "${{ github.sha }}" \
            --backend "${BACKEND}"

      - name: Write GitHub Job Summary
        run: |
          python tools/summary.py

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sim-bridge-artifacts
          path: |
            ./.artifacts/*.csv
            ./.artifacts/*.parquet
            ./.artifacts/*.metrics.json
            ./.artifacts/*.events.ndjson
            ./.artifacts/SUMMARY.md
            ./.artifacts/summary.png
