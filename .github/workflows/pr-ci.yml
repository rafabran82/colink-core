name: PR CI
on:
  workflow_dispatch:
  pull_request:
  pull_request_target:
  push:
    branches: [ main ]

permissions:
  contents: read

jobs:
  build-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (safe)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Sanity: parse main.py for top-level \pp\
        shell: bash
        run: |
          set -euo pipefail
          if [[ ! -f main.py ]]; then
            echo "main.py not found" >&2; exit 1
          fi
          python - <<'PY'
          import ast,sys
          with open("main.py","rb") as f:
              try:
                  tree = ast.parse(f.read().decode("utf-8"), filename="main.py")
              except SyntaxError as e:
                  print(f"Syntax error in main.py: {e}", file=sys.stderr); sys.exit(1)
          app_found=False
          for n in ast.walk(tree):
              if isinstance(n, ast.Assign):
                  for t in n.targets:
                      if isinstance(t, ast.Name) and t.id=="app":
                          app_found=True; break
              if app_found: break
          if not app_found:
              print("Expected a top-level name \pp\ in main.py", file=sys.stderr); sys.exit(1)
          print("Found top-level \pp\ symbol ✔")
          PY
