name: Sim Smoke

on:
  workflow_dispatch:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  smoke:
    strategy:
      fail-fast: false
      matrix:
        os: [ ubuntu-latest, windows-latest ]
        pair: [ XRP-COL, COPX-COL ]
        python: [ "3.11", "3.12" ]
    runs-on: ${{ matrix.os }}
    timeout-minutes: 20
    env:
      MPLBACKEND: Agg

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python (with pip cache)
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}
          cache: pip

      - name: Install minimal deps
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          pip install numpy==2.* matplotlib==3.*

      # ===== Windows path: keep your PS script, now with proper 'Agg' =====
      - name: Run smoke (PowerShell)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Write-Host "Windows smoke via tools\verify-sim.ps1"
          .\tools\verify-sim.ps1 -Pair '${{ matrix.pair }}' -Python "python" -Display "Agg"

      # ===== Ubuntu path: avoid PowerShell; call the sim directly =====
      - name: Run smoke (Bash)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p .artifacts
          echo "Linux smoke via direct Python (headless Agg)"
          python - <<'PY'
          import os, sys, subprocess
          os.environ["MPLBACKEND"] = "Agg"
          cmd = [sys.executable, "-m", "colink_core.sim.run",
                 "--demo", "--display", "Agg",
                 "--out-prefix", "./.artifacts/demo"]
          print("Running:", " ".join(cmd), flush=True)
          sys.exit(subprocess.call(cmd))
          PY

      - name: Upload smoke artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sim-smoke-${{ matrix.os }}-${{ matrix.pair }}-py${{ matrix.python }}
          path: |
            .artifacts/*.png
            .artifacts/*.json
            .artifacts/*.ndjson
          if-no-files-found: warn
      - name: Ensure stub artifact (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path .artifacts | Out-Null
          $stub = @{
            os      = "$env:RUNNER_OS"
            pair    = "${{ matrix.pair }}"
            python  = "${{ matrix.python }}"
            status  = "ok"
            branch  = "${{ github.ref_name }}"
            run_id  = "${{ github.run_id }}"
          } | ConvertTo-Json -Compress
          Set-Content .artifacts/smoke_summary.json -Value $stub -Encoding utf8

<<<<<<< HEAD
      - name: Ensure stub artifact (Linux)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          mkdir -p .artifacts
          printf '{"os":"%s","pair":"%s","python":"%s","status":"ok","branch":"%s","run_id":"%s"}' \
            "$RUNNER_OS" "${{ matrix.pair }}" "${{ matrix.python }}" "${{ github.ref_name }}" "${{ github.run_id }}" \
            > .artifacts/smoke_summary.json
=======

>>>>>>> origin/main
